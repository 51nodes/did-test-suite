<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Test Suite and Implementation Report</title>
    <script
      src="https://www.w3.org/Tools/respec/respec-w3c"
      defer="defer"
      class="remove"
    ></script>
    <script class="remove">
      // See https://github.com/w3c/respec/wiki/ for how to configure ReSpec
      var respecConfig = {
        specStatus: 'ED',
        shortName: 'did-test-suite',
        group: 'did',
        github: {
          repoURL: 'https://github.com/w3c/did-test-suite/',
          branch: 'master',
        },
        editors: [
          {
            name: 'Orie Steele',
            url: 'https://www.linkedin.com/in/or13b/',
            company: 'Transmute',
            companyURL: 'https://www.transmute.industries/',
            w3cid: 109171,
          },
        ],
        noRecTrack: 'true',
      };
    </script>
  </head>
  <body>
    <section id="abstract">
      <p>This document contains a summary of the did test suite.</p>
    </section>
    <section id="sotd">
      <p>
        This document is under active development and implementers are advised
        against using the document unless they are directly involved with the
        W3C DID Working Group.
      </p>
    </section>

    <section id="introduction">
      <h2>Introduction</h2>
      <p>This document contains a summary of the did test suite results.</p>
    </section>

    <section>
      <h2>Terminology</h2>

      <p>This section defines the terms used in the did core test suite.</p>

      <section>
        <h2>Scenario</h2>

        <p>
          A scenario is a json data structure containing all inputs and outputs
          needed to test a collection of normative statements.
        </p>

        <p>Scenarios MUST have unique descriptive names.</p>
        <p>Scenarios MAY be split into positive and negative cases.</p>
        <p>
          If a scenario ending in <code>-positive-tests</code> exists, a
          corrosponding<code>-negative-tests</code> scenario MUST exist.
        </p>
        <p>
          A scenarios is considered passing when all associated assertions are
          true.
        </p>
        <p>
          A scenarios is considered passing when all associated assertions are
          true.
        </p>
      </section>

      <section>
        <h2>Assertion</h2>
        <p>
          An assertion is a function from <code>scenario</code> to
          <code>boolean</code>.
        </p>
        <p>Assertions SHOULD match normative statements in the DID Core.</p>
        <p>
          Assertions SHOULD reuse utility functions like
          <code>isAsciiString</code>, or <code>decodeBase64UrlToString</code>.
        </p>
      </section>
    </section>

    <section id="test-results">
      <h2>Scenarios</h2>
    </section>

    <section id="raw-test-results">
      <h2>Latest Results</h2>
      <p id="raw-rest-results-last-updated" class="note">
        These test results were last generated
        <span id="raw-rest-results-last-updated-date">
          Saturday, September 26, 2020 4:30 PM
        </span>
      </p>
      <p class="note">
        Scenarios ending is <code>-positive-tests</code> and
        <code>-negative-tests</code> are merged above for readability.
      </p>
      <script type="application/json" id="test-results-raw-json">
        {
          "test": "PASS",
          "scenarios": [
            {
              "scenario": "resolve",
              "test": "PASS",
              "assertion_results": {
                "did should match did-document id": true
              }
            },
            {
              "scenario": "did-parameters-negative-tests",
              "test": "PASS",
              "assertion_results": {
                "[hl] The associated value MUST be an ASCII string.": true,
                "[service] The associated value MUST be an ASCII string.": true,
                "[version-id] The associated value MUST be an ASCII string.": true,
                "[version-time] The associated value MUST be an ASCII string.": true,
                "[relative-ref] The associated value MUST be an ASCII string and MUST use percent-encoding for certain characters as specified in RFC3986 Section 2.1.": true
              }
            },
            {
              "scenario": "did-parameters-positive-tests",
              "test": "PASS",
              "assertion_results": {
                "[hl] The associated value MUST be an ASCII string.": true,
                "[service] The associated value MUST be an ASCII string.": true,
                "[version-id] The associated value MUST be an ASCII string.": true,
                "[version-time] The associated value MUST be an ASCII string.": true,
                "[relative-ref] The associated value MUST be an ASCII string and MUST use percent-encoding for certain characters as specified in RFC3986 Section 2.1.": true
              }
            }
          ]
        }
      </script>
    </section>

    <script>
      const testResultsRelativeUrl = '/test-all-results.json';
      const rawTestResultsContainer = 'raw-test-results';
      const testResultsContainer = 'test-results';

      const resultToEmoji = (test) => {
        return test === 'PASS' ? `✅` : `❌`;
      };

      const booleanToTestResult = (bool) => {
        return bool ? `PASS` : `FAIL`;
      };

      const booleanToEmoji = (bool) => {
        return resultToEmoji(booleanToTestResult(bool));
      };

      const renderRows = (scenario) => {
        return Object.keys(scenario.assertion_results)
          .map((assertion) => {
            const bool = scenario.assertion_results[assertion];
            return `
            <tr>
              <td>${booleanToEmoji(bool)}</td>
              <td>${assertion}</td>
            </tr>
            `;
          })
          .join('');
      };

      const renderScenario = (scenario) => {
        return `
      <section>
        <h3>${scenario.scenario}</h3>
        <p>
        ${resultToEmoji(scenario.test)} ${scenario.scenario}
        </p>

        <table class="simple" style="width: 100%;">
          <tr>
            <th></th>
            <th>Statements</th>
          </tr>
          ${renderRows(scenario)}
        </table>
      </section>
      `;
      };

      const renderRawTestResults = (results) => {
        document.getElementById(
          rawTestResultsContainer
        ).innerHTML += `<pre>${JSON.stringify(results, null, 2)}</pre>`;
      };

      const renderPrettyTestResults = (results) => {
        let str = results.scenarios.map(renderScenario).join('');
        document.getElementById(testResultsContainer).innerHTML += str;
      };

      const getResults = async () => {
        let results = undefined;
        // not possible to file split because of PR Preview:
        // See https://github.com/tobie/pr-preview/issues/80
        // try {
        //   let url = testResultsRelativeUrl;
        //   if (window.origin === 'https://pr-preview.s3.amazonaws.com') {
        //     url = `https://pr-preview.s3.amazonaws.com/w3c/did-test-suite/pull/${testResultsRelativeUrl}`;
        //   }
        //   results = await fetch(url).then((response) => response.json());
        // } catch (e) {
        //   console.warn(e);
        // }
        // if (results) {
        //   return results;
        // }
        results = JSON.parse(
          document.getElementById('test-results-raw-json').innerHTML
        );
        return results;
      };

      const mergePositiveAndNegativeTests = (results) => {
        const simpleScenarios = results.scenarios.filter((s) => {
          return (
            s.scenario.indexOf('positive') === -1 &&
            s.scenario.indexOf('negative') === -1
          );
        });
        const positiveOrNegativeScenarios = results.scenarios.filter((s) => {
          return (
            s.scenario.indexOf('positive') !== -1 ||
            s.scenario.indexOf('negative') !== -1
          );
        });
        const merged = {};
        while (positiveOrNegativeScenarios.length) {
          const s = positiveOrNegativeScenarios.pop();
          let name = s.scenario.replace('-positive-tests', '');
          name = name.replace('-negative-tests', '');
          if (!merged[name]) {
            merged[name] = s;
            merged[name].scenario = name;
          } else {
            const assertionKeys = Object.keys(merged[name].assertion_results);
            assertionKeys.forEach((assert) => {
              merged[name].assertion_results[assert] =
                merged[name].assertion_results[assert] &&
                s.assertion_results[assert];
            });
          }
        }
        return {
          scenarios: [...simpleScenarios, ...Object.values(merged)],
        };
      };

      const renderTestResults = () => {
        (async () => {
          const results = await getResults();
          const mergedResults = mergePositiveAndNegativeTests(results);
          renderPrettyTestResults(mergedResults);
          renderRawTestResults(results);
        })();
      };

      renderTestResults();
    </script>

    <section id="conformance">
      <p>
        A conforming DID Library must be able to handle the scenarios specified
        in JSON, and should throw errors or return structured responses that
        match the normative statements this test suite covers.
      </p>
    </section>
  </body>
</html>
